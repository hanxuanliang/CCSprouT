<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>IP是怎么来的，又是怎么没的？ | Coding Core Sprout</title>
    <meta name="description" content="Coding Core Sprout：处于萌芽阶段的 Code 核心知识库">
    
    
    <link rel="preload" href="/CCSprouT/assets/css/0.styles.b6092737.css" as="style"><link rel="preload" href="/CCSprouT/assets/js/app.49fb676b.js" as="script"><link rel="preload" href="/CCSprouT/assets/js/2.354977f3.js" as="script"><link rel="preload" href="/CCSprouT/assets/js/8.5acee05e.js" as="script"><link rel="prefetch" href="/CCSprouT/assets/js/10.b2183c85.js"><link rel="prefetch" href="/CCSprouT/assets/js/11.9dab4441.js"><link rel="prefetch" href="/CCSprouT/assets/js/12.389ed354.js"><link rel="prefetch" href="/CCSprouT/assets/js/13.41e408bc.js"><link rel="prefetch" href="/CCSprouT/assets/js/14.e3228b11.js"><link rel="prefetch" href="/CCSprouT/assets/js/15.86717abc.js"><link rel="prefetch" href="/CCSprouT/assets/js/16.7b9ec5d6.js"><link rel="prefetch" href="/CCSprouT/assets/js/17.7f7f72e9.js"><link rel="prefetch" href="/CCSprouT/assets/js/18.d476d94e.js"><link rel="prefetch" href="/CCSprouT/assets/js/19.c2d4461c.js"><link rel="prefetch" href="/CCSprouT/assets/js/20.7fbb6321.js"><link rel="prefetch" href="/CCSprouT/assets/js/21.f5baf50c.js"><link rel="prefetch" href="/CCSprouT/assets/js/22.5f32fbc1.js"><link rel="prefetch" href="/CCSprouT/assets/js/23.3127ef67.js"><link rel="prefetch" href="/CCSprouT/assets/js/24.45a3e693.js"><link rel="prefetch" href="/CCSprouT/assets/js/25.65fbf2ce.js"><link rel="prefetch" href="/CCSprouT/assets/js/26.9720875f.js"><link rel="prefetch" href="/CCSprouT/assets/js/27.bf51662e.js"><link rel="prefetch" href="/CCSprouT/assets/js/28.0fb4b375.js"><link rel="prefetch" href="/CCSprouT/assets/js/29.760ea0ec.js"><link rel="prefetch" href="/CCSprouT/assets/js/3.01f6de79.js"><link rel="prefetch" href="/CCSprouT/assets/js/30.2b254b0e.js"><link rel="prefetch" href="/CCSprouT/assets/js/31.10ea0858.js"><link rel="prefetch" href="/CCSprouT/assets/js/32.42ac6477.js"><link rel="prefetch" href="/CCSprouT/assets/js/33.04c5ffa1.js"><link rel="prefetch" href="/CCSprouT/assets/js/34.733182cb.js"><link rel="prefetch" href="/CCSprouT/assets/js/35.21e59dc5.js"><link rel="prefetch" href="/CCSprouT/assets/js/36.c0e0caa9.js"><link rel="prefetch" href="/CCSprouT/assets/js/37.01673a94.js"><link rel="prefetch" href="/CCSprouT/assets/js/4.02903aa1.js"><link rel="prefetch" href="/CCSprouT/assets/js/5.1180d80c.js"><link rel="prefetch" href="/CCSprouT/assets/js/6.defea5f2.js"><link rel="prefetch" href="/CCSprouT/assets/js/7.8e3e12db.js"><link rel="prefetch" href="/CCSprouT/assets/js/9.9814eaf1.js">
    <link rel="stylesheet" href="/CCSprouT/assets/css/0.styles.b6092737.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/CCSprouT/" class="home-link router-link-active"><!----> <span class="site-name">Coding Core Sprout</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/CCSprouT/welcome/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">My-Blog</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/mysql/" class="nav-link">Mysql</a></li><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/network/" class="nav-link router-link-active">Network</a></li><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/python/" class="nav-link">AdvancePython</a></li></ul></div></div><div class="nav-item"><a href="/CCSprouT/ts-axios/" class="nav-link">TS-axios 重构文档</a></div><div class="nav-item"><a href="https://github.com/hanxuanliang/CCSprouT" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/CCSprouT/welcome/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">My-Blog</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/mysql/" class="nav-link">Mysql</a></li><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/network/" class="nav-link router-link-active">Network</a></li><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/python/" class="nav-link">AdvancePython</a></li></ul></div></div><div class="nav-item"><a href="/CCSprouT/ts-axios/" class="nav-link">TS-axios 重构文档</a></div><div class="nav-item"><a href="https://github.com/hanxuanliang/CCSprouT" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Network</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CCSprouT/blog/network/" class="sidebar-link">Introduction</a></li><li><a href="/CCSprouT/blog/network/IP-From.html" class="active sidebar-link">IP是怎么来的，又是怎么没的？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CCSprouT/blog/network/IP-From.html#如何配置ip地址？" class="sidebar-link">如何配置IP地址？</a></li><li class="sidebar-sub-header"><a href="/CCSprouT/blog/network/IP-From.html#动态主机配置协议（dhcp）" class="sidebar-link">动态主机配置协议（DHCP）</a></li><li class="sidebar-sub-header"><a href="/CCSprouT/blog/network/IP-From.html#总结-2" class="sidebar-link">总结</a></li></ul></li><li><a href="/CCSprouT/blog/network/about-UDP.html" class="sidebar-link">Hello world，UDP</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="content default"><h1 id="ip是怎么来的，又是怎么没的？"><a href="#ip是怎么来的，又是怎么没的？" aria-hidden="true" class="header-anchor">#</a> IP是怎么来的，又是怎么没的？</h1> <p>在网络世界里面，如果需要和其他机器通讯，我们一个通讯地址，所以我们需要给网卡配置这么一个地址。</p> <h2 id="如何配置ip地址？"><a href="#如何配置ip地址？" aria-hidden="true" class="header-anchor">#</a> 如何配置IP地址？</h2> <p>使用命令行自己配置即可。设置好了，用这两个命令，将网卡up一下，就可以开始工作。</p> <div class="language- extra-class"><pre class="language-text"><code>sudo ifconfig eth1 10.0.0.1/24
sudo ifconfig eth1 up
</code></pre></div><p>你可能会问，这也太自由了，那我是不是配置什么都可以？如果配置一个和谁都不搭边的地址呢？例如，机房旁边的机器都是192.168.1.x，我非要配置一个16.158.23.6，会出现什么现象？</p> <p>哈哈哈！不会出现任何现象，<strong>就是包发不出去</strong>。为什么呢？我来举例说明一下。</p> <h3 id="解释"><a href="#解释" aria-hidden="true" class="header-anchor">#</a> 解释</h3> <p>192.168.1.6 就在你这台机器的旁边，甚至是在同一个交换机上，而你把机器的地址设为了 16.158.23.6。在这台机器上，你企图去 ping192.168.1.6，你觉得只要将包发出去，同一个交换机的另一台机器马上就能收到，对不对？</p> <p>可是它没你想得那么智能。你用肉眼看到那台机器就在旁边，它则需要根据自己的逻辑进行处理。</p> <blockquote><p>网络交换资源的原则：<strong>只要是在网络上跑的包，都是完整的，可以有下层没上层，绝对不可能有上层没下层。</strong></p></blockquote> <p>所以，你看着它有自己的源 IP 地址 16.158.23.6，也有目标 IP 地址 192.168.1.6，但是包发不出去，这是因为 MAC 层还没填。</p> <p>自己的 MAC 地址自己知道，这个容易。但是目标 MAC 填什么呢？是不是填 192.168.1.6 这台机器的 MAC 地址呢？</p> <p>当然不是。机器首先会判断，要去的这个地址和我是一个网段的吗，或者和我的一个网卡是同一网段的吗？只有是一个网段的，它才会发送 ARP 请求，获取 MAC 地址。如果发现不是呢？</p> <blockquote><p><strong>Linux 默认的逻辑是，如果这是一个跨网段的调用，它便不会直接将包发送到网络上，而是企图将包发送到网关。</strong></p></blockquote> <p>如果你配置了网关的话，Linux 会获取网关的 MAC 地址，然后将包发出去。对于 192.168.1.6 这台机器来讲，虽然路过它家门的这个包，目标 IP 是它，但是无奈 MAC 地址不是它的，所以它的网卡是不会把包收进去的。</p> <p>如果没有配置网关呢？那包压根就发不出去。</p> <p>如果将网关配置为 192.168.1.6 呢？不可能，Linux 不会让你配置成功的，因为网关要和当前的网络至少一个网卡是同一个网段的，怎么可能 16.158.23.6 的网关是 192.168.1.6 呢？</p> <p>所以，当你需要手动配置一台机器的网络 IP 时，一定要好好问问你的网络管理员。如果在机房里面，要去网络管理员那里申请，让他给你分配一段正确的 IP 地址。当然，真正配置的时候，一定不是直接用命令配置的，而是放在一个配置文件里面。<strong>不同系统的配置文件格式不同，但是无非就是 CIDR、子网掩码、广播地址和网关地址</strong>。</p> <h3 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h3> <ul><li><p>知道互相的IP地址，MAC地址也得知道（上层协议需要下层协议的支持）</p></li> <li><p>如果是一个网段，它会发送 ARP 请求，获取 MAC 地址。</p></li> <li><p>如果这是一个跨网段的调用，它便不会直接将包发送到网络上，而是企图将包发送到网关。</p></li></ul> <h2 id="动态主机配置协议（dhcp）"><a href="#动态主机配置协议（dhcp）" aria-hidden="true" class="header-anchor">#</a> 动态主机配置协议（DHCP）</h2> <p>你可能会问了，配置了 IP 之后一般不能变的，配置一个服务端的机器还可以，但是如果是客户端的机器呢？我抱着一台笔记本电脑到处走，或者白天来晚上走，每次使用都要配置 IP 地址，那可怎么办？如果公司所有的电脑都需要 IT 人员配置，肯定忙不过来啊。</p> <p>因此，我们需要有一个自动配置的协议，也就是称<strong>动态主机配置协议（Dynamic Host Configuration Protocol）</strong>，简称<strong>DHCP</strong>。</p> <p>有了这个协议，网络管理员就轻松多了。<strong>他只需要配置一段共享的 IP 地址</strong>。每一台新接入的机器都通过 DHCP 协议，来这个共享的 IP 地址里申请，然后自动配置好就可以了。<strong>等人走了，或者用完了，还回去，这样其他的机器也能用。</strong></p> <h3 id="解析dhcp的工作方式"><a href="#解析dhcp的工作方式" aria-hidden="true" class="header-anchor">#</a> 解析DHCP的工作方式</h3> <p>当一台机器新加入一个网络的时候，肯定一脸懵逼，啥情况都不知道，只知道自己的 MAC 地址。这一步，我们称为<strong>DHCP Discover。</strong></p> <p>新来的机器使用 <strong>IP 地址 0.0.0.0</strong> 发送了一个<strong>广播包</strong>，<strong>目的 IP 地址为 255.255.255.255</strong>。广播包封装了 UDP，UDP 封装了 BOOTP。其实 DHCP 是 BOOTP 的增强版，但是如果你去抓包的话，很可能看到的名称还是 BOOTP 协议。</p> <img src="/CCSprouT/network/DHCP-Discover.jpg" alt="DHCP-Discover"> <p>如果一个网络管理员在网络里面配置了<strong>DHCP Server</strong>的话，他就相当于这些 IP 的管理员。他立刻能知道来了一个“新人”。这个时候，我们可以体会 MAC 地址唯一的重要性了。当一台机器带着自己的 MAC 地址加入一个网络的时候，MAC 是它唯一的身份，如果连这个都重复了，就没办法配置了。</p> <p>只有 MAC 唯一，IP 管理员才能知道这是一个新人，需要租给它一个 IP 地址，这个过程我们称为<strong>DHCP Offer</strong>。同时，DHCP Server 为此客户保留为它提供的 IP 地址，从而不会为其他 DHCP 客户分配此 IP 地址。</p> <p>DHCP Offer 的格式就像这样，里面有给新人分配的地址。</p> <img src="/CCSprouT/network/DHCP-Offer.jpg" alt="DHCP-Offer"> <p>DHCP Server 仍然使用<strong>广播地址作为目的地址</strong>，因为，此时请求分配 IP 的新人还没有自己的 IP。DHCP Server 回复说，我分配了一个可用的 IP 给你，你看如何？除此之外，服务器还发送了子网掩码、网关和 IP 地址租用期等信息。</p> <p>如果有多个 DHCP Server，它会选择其中一个 DHCP Offer，一般是最先到达的那个，并且会向网络发送一个 <strong>DHCP Request 广播数据包</strong>，包中包含<strong>客户端的 MAC 地址、接受的租约中的 IP 地址、提供此租约的 DHCP 服务器地址</strong>等，并告诉所有 DHCP Server 它将接受哪一台服务器提供的 IP 地址，告诉其他 DHCP 服务器，谢谢你们的接纳，并请求撤销它们提供的 IP 地址，以便提供给下一个 IP 租用请求者。</p> <img src="/CCSprouT/network/DHCP-Request广播数据包.jpg" alt="DHCP-Request广播数据包"> <p>此时，由于还没有得到 DHCP Server 的最后确认，客户端仍然使用 0.0.0.0 为源 IP 地址、255.255.255.255 为目标地址进行广播。在 BOOTP 里面，接受某个 DHCP Server 的分配的 IP。</p> <p>当 DHCP Server 接收到客户机的 DHCP request 之后，会广播返回给客户机一个 DHCP ACK 消息包，表明已经接受客户机的选择，并将这一 IP 地址的合法租用信息和其他的配置信息都放入该广播包，发给客户机，欢迎它加入网络大家庭。</p> <blockquote><p>有点像3次握手，但是网络世界的东西不就是异曲同工之妙吗</p></blockquote> <img src="/CCSprouT/network/DHCP-Server确定.jpg" alt="DHCP-Server确定"> <h3 id="ip是怎么收回的"><a href="#ip是怎么收回的" aria-hidden="true" class="header-anchor">#</a> IP是怎么收回的</h3> <p>如果不用的话，自然就会收回了。而如果还要继续续期的话，不能到了时间再续期，而是提前一段时间和DHCP服务端说。</p> <blockquote><p>客户机会在租期过去 50% 的时候，直接向为其提供 IP 地址的 DHCP Server 发送 DHCP request 消息包。客户机接收到该服务器回应的 DHCP ACK 消息包，会根据包中所提供的新的租期以及其他已经更新的 TCP/IP 参数，更新自己的配置。这样，IP 租用更新就完成了。</p></blockquote> <h2 id="总结-2"><a href="#总结-2" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <ul><li>DHCP 协议主要是用来给客户租用 IP 地址，和房产中介很像，要商谈、签约、续租，广播还不能“抢单”（先来先得，迟到了就下一次吧）</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2019-5-9 17:54:08</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/CCSprouT/blog/network/" class="prev router-link-active">
          Introduction
        </a></span> <span class="next"><a href="/CCSprouT/blog/network/about-UDP.html">
          Hello world，UDP
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/CCSprouT/assets/js/app.49fb676b.js" defer></script><script src="/CCSprouT/assets/js/2.354977f3.js" defer></script><script src="/CCSprouT/assets/js/8.5acee05e.js" defer></script>
  </body>
</html>
