<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>你应该知道的HTTP协议 | Coding Core Sprout</title>
    <meta name="description" content="Coding Core Sprout：处于萌芽阶段的 Code Repository">
    
    
    <link rel="preload" href="/CCSprouT/assets/css/0.styles.b6092737.css" as="style"><link rel="preload" href="/CCSprouT/assets/js/app.3bfe9cae.js" as="script"><link rel="preload" href="/CCSprouT/assets/js/2.354977f3.js" as="script"><link rel="preload" href="/CCSprouT/assets/js/16.6a35fdc0.js" as="script"><link rel="prefetch" href="/CCSprouT/assets/js/10.45b843d1.js"><link rel="prefetch" href="/CCSprouT/assets/js/11.e4062db1.js"><link rel="prefetch" href="/CCSprouT/assets/js/12.9c627950.js"><link rel="prefetch" href="/CCSprouT/assets/js/13.26612607.js"><link rel="prefetch" href="/CCSprouT/assets/js/14.ff4e4a20.js"><link rel="prefetch" href="/CCSprouT/assets/js/15.a0266fcd.js"><link rel="prefetch" href="/CCSprouT/assets/js/17.3de5d84d.js"><link rel="prefetch" href="/CCSprouT/assets/js/18.76424749.js"><link rel="prefetch" href="/CCSprouT/assets/js/19.c9d3905d.js"><link rel="prefetch" href="/CCSprouT/assets/js/20.8a9fd492.js"><link rel="prefetch" href="/CCSprouT/assets/js/21.1177fac8.js"><link rel="prefetch" href="/CCSprouT/assets/js/22.af347df1.js"><link rel="prefetch" href="/CCSprouT/assets/js/23.27183461.js"><link rel="prefetch" href="/CCSprouT/assets/js/24.a168e5ee.js"><link rel="prefetch" href="/CCSprouT/assets/js/25.6d454097.js"><link rel="prefetch" href="/CCSprouT/assets/js/26.a00a3bea.js"><link rel="prefetch" href="/CCSprouT/assets/js/27.f936fe6d.js"><link rel="prefetch" href="/CCSprouT/assets/js/28.6c80d6f0.js"><link rel="prefetch" href="/CCSprouT/assets/js/29.02acd1c8.js"><link rel="prefetch" href="/CCSprouT/assets/js/3.dcf3ad81.js"><link rel="prefetch" href="/CCSprouT/assets/js/30.3ea69c5d.js"><link rel="prefetch" href="/CCSprouT/assets/js/31.9e9abe71.js"><link rel="prefetch" href="/CCSprouT/assets/js/32.ec575d40.js"><link rel="prefetch" href="/CCSprouT/assets/js/33.11753ff6.js"><link rel="prefetch" href="/CCSprouT/assets/js/34.6bd95441.js"><link rel="prefetch" href="/CCSprouT/assets/js/35.2ef9c3b5.js"><link rel="prefetch" href="/CCSprouT/assets/js/36.523dd0f6.js"><link rel="prefetch" href="/CCSprouT/assets/js/37.508cd470.js"><link rel="prefetch" href="/CCSprouT/assets/js/38.bdbf4774.js"><link rel="prefetch" href="/CCSprouT/assets/js/39.cc6e2686.js"><link rel="prefetch" href="/CCSprouT/assets/js/4.02903aa1.js"><link rel="prefetch" href="/CCSprouT/assets/js/40.e2be7e61.js"><link rel="prefetch" href="/CCSprouT/assets/js/5.662524a8.js"><link rel="prefetch" href="/CCSprouT/assets/js/6.415fb556.js"><link rel="prefetch" href="/CCSprouT/assets/js/7.82ad5c3b.js"><link rel="prefetch" href="/CCSprouT/assets/js/8.29dc5621.js"><link rel="prefetch" href="/CCSprouT/assets/js/9.ca5b5375.js">
    <link rel="stylesheet" href="/CCSprouT/assets/css/0.styles.b6092737.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/CCSprouT/" class="home-link router-link-active"><!----> <span class="site-name">Coding Core Sprout</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/CCSprouT/welcome/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">My-Blog</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/mysql/" class="nav-link">Mysql</a></li><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/network/" class="nav-link">Network</a></li><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/python/" class="nav-link">AdvancePython</a></li><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/tomcat/" class="nav-link router-link-active">Tomcat容器</a></li></ul></div></div><div class="nav-item"><a href="/CCSprouT/ts-axios/" class="nav-link">TS-axios 重构文档</a></div><div class="nav-item"><a href="https://github.com/hanxuanliang/CCSprouT" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/CCSprouT/welcome/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">My-Blog</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/mysql/" class="nav-link">Mysql</a></li><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/network/" class="nav-link">Network</a></li><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/python/" class="nav-link">AdvancePython</a></li><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/tomcat/" class="nav-link router-link-active">Tomcat容器</a></li></ul></div></div><div class="nav-item"><a href="/CCSprouT/ts-axios/" class="nav-link">TS-axios 重构文档</a></div><div class="nav-item"><a href="https://github.com/hanxuanliang/CCSprouT" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Tomcat容器</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CCSprouT/blog/tomcat/" class="sidebar-link">Tomcat 容器</a></li><li><a href="/CCSprouT/blog/tomcat/http-protocol.html" class="active sidebar-link">你应该知道的HTTP协议</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CCSprouT/blog/tomcat/http-protocol.html#你应该知道的http协议" class="sidebar-link">你应该知道的HTTP协议</a></li><li class="sidebar-sub-header"><a href="/CCSprouT/blog/tomcat/http-protocol.html#http本质" class="sidebar-link">HTTP本质</a></li><li class="sidebar-sub-header"><a href="/CCSprouT/blog/tomcat/http-protocol.html#http工作原理" class="sidebar-link">HTTP工作原理</a></li><li class="sidebar-sub-header"><a href="/CCSprouT/blog/tomcat/http-protocol.html#http里面request-response" class="sidebar-link">HTTP里面Request Response</a></li><li class="sidebar-sub-header"><a href="/CCSprouT/blog/tomcat/http-protocol.html#cookie和session" class="sidebar-link">Cookie和Session</a></li><li class="sidebar-sub-header"><a href="/CCSprouT/blog/tomcat/http-protocol.html#关于无状态" class="sidebar-link">关于无状态</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="content default"><h2 id="你应该知道的http协议"><a href="#你应该知道的http协议" aria-hidden="true" class="header-anchor">#</a> 你应该知道的HTTP协议</h2> <p>之前我们讲了<code>Tomcat本身就是一个“HTTP服务器 + Servlet容器”</code>，所以理解HTTP协议的工作原理是学习Web容器的基础。</p> <h2 id="http本质"><a href="#http本质" aria-hidden="true" class="header-anchor">#</a> HTTP本质</h2> <p>HTTP协议是浏览器与服务器之间的数据传送协议。作为应用层协议，HTTP是基于TCP/IP协议来传递数据的（HTML文件、图片、查询结果等），HTTP协议不涉及数据包（Packet）传输，主要规定了客户端和服务器之间的通信格式。</p> <p>假如浏览器需要从远程HTTP服务器获取一个HTML文本，在这个过程中，浏览器实际上要做两件事情。</p> <ul><li>与服务器建立Socket连接。</li> <li>生成请求数据并通过Socket发送出去。</li></ul> <p>第一步比较容易理解，浏览器从地址栏获取用户输入的网址和端口，去连接远端的服务器，这样就能通信了。</p> <p>我们重点来看第二步，这个请求数据到底长什么样呢？都请求些什么内容呢？或者换句话说，浏览器需要告诉服务端什么信息呢？</p> <p>首先最基本的是，你要让服务端知道你的意图，你是想获取内容还是提交内容；其次你需要告诉服务端你想要哪个内容。那么要把这些信息以一种什么样的格式放到请求里去呢？这就是HTTP协议要解决的问题。也就是说，<strong>HTTP协议的本质就是一种浏览器与服务器之间约定好的通信格式</strong>。那浏览器与服务器之间具体是怎么工作的呢？</p> <h2 id="http工作原理"><a href="#http工作原理" aria-hidden="true" class="header-anchor">#</a> HTTP工作原理</h2> <blockquote><ol><li>用户通过浏览器进行了一个操作，比如输入网址并回车，或者是点击链接，接着浏览器获取了这个事件。</li> <li>浏览器向服务端发出TCP连接请求。</li> <li>服务程序接受浏览器的连接请求，并经过TCP三次握手建立连接。</li> <li>浏览器将请求数据打包成一个HTTP协议格式的数据包。</li> <li>浏览器将该数据包推入网络，数据包经过网络传输，最终达到端服务程序。</li> <li>服务端程序拿到这个数据包后，同样以HTTP协议格式解包，获取到客户端的意图。</li> <li>得知客户端意图后进行处理，比如提供静态文件或者调用服务端程序获得动态结果。</li> <li>服务器将响应结果（可能是HTML或者图片等）按照HTTP协议格式打包。</li> <li>服务器将响应数据包推入网络，数据包经过网络传输最终达到到浏览器。</li> <li>浏览器拿到数据包后，以HTTP协议的格式解包，然后解析数据，假设这里的数据是HTML。</li> <li>浏览器将HTML文件展示在页面上。</li></ol></blockquote> <p>那我们想要探究的Tomcat作为一个HTTP服务器，在这个过程中都做了些什么事情呢？主要是接受连接、解析请求数据、处理请求和发送响应这几个步骤。这里请你注意，可能有成千上万的浏览器同时请求同一个HTTP服务器，因此Tomcat为了提高服务的能力和并发度，往往会将自己要做的几个事情并行化，具体来说就是使用多线程的技术。</p> <h2 id="http里面request-response"><a href="#http里面request-response" aria-hidden="true" class="header-anchor">#</a> HTTP里面Request Response</h2> <p>在浏览器和HTTP服务器之间通信的过程中，首先要将数据打包成HTTP协议的格式，那HTTP协议的数据包具体长什么样呢？这里我以某个登陆请求为例，用户在登陆页面输入用户名和密码，点击登陆后，浏览器发出了这样的HTTP请求：</p> <img src="/CCSprouT/tomcat/request.png" alt="HTTP的请求格式"> <p>你可以看到，HTTP请求数据由三部分组成，分别是<strong>请求行、请求报头、请求正文</strong>。当这个HTTP请求数据到达Tomcat后，Tomcat会把HTTP请求数据字节流解析成一个Request对象，这个Request对象封装了HTTP所有的请求信息。接着Tomcat把这个Request对象交给Web应用去处理，处理完后得到一个Response对象，Tomcat会把这个Response对象转成HTTP格式的响应数据并发送给浏览器。</p> <p>我们再来看看HTTP响应的格式，HTTP的响应也是由三部分组成，分别是<strong>状态行、响应报头、报文主体</strong>。</p> <img src="/CCSprouT/tomcat/response.jpg" alt="HTTP的响应格式"> <h2 id="cookie和session"><a href="#cookie和session" aria-hidden="true" class="header-anchor">#</a> Cookie和Session</h2> <p>我们知道，HTTP协议有个特点是无状态，请求与请求之间是没有关系的。这样会出现一个很尴尬的问题：Web应用不知道你是谁。比如你登陆淘宝后，在购物车中添加了三件商品，刷新一下网页，这时系统提示你仍然处于未登录的状态，购物车也空了，很显然这种情况是不可接受的。因此HTTP协议需要一种技术让请求与请求之间建立起联系，并且服务器需要知道这个请求来自哪个用户，于是Cookie技术出现了。</p> <p><strong>1. Cookie技术</strong></p> <p>Cookie是HTTP报文的一个请求头，Web应用可以将用户的标识信息或者其他一些信息（用户名等）存储在Cookie中。用户经过验证之后，每次HTTP请求报文中都包含Cookie，这样服务器读取这个Cookie请求头就知道用户是谁了。<strong>Cookie本质上就是一份存储在用户本地的文件，里面包含了每次请求中都需要传递的信息</strong>。</p> <p><strong>2. Session技术</strong></p> <p>由于Cookie以明文的方式存储在本地，而Cookie中往往带有用户信息，这样就造成了非常大的安全隐患。而Session的出现解决了这个问题，<strong>Session可以理解为服务器端开辟的存储空间，里面保存了用户的状态</strong>，用户信息以Session的形式存储在服务端。当用户请求到来时，服务端可以把用户的请求和用户的Session对应起来。那么Session是怎么和请求对应起来的呢？答案是通过Cookie，浏览器在Cookie中填充了一个Session ID之类的字段用来标识请求。</p> <p><strong>具体工作过程是这样的：</strong></p> <blockquote><ol><li>服务器在创建Session的同时，会为该Session生成唯一的<code>Session ID</code>。</li> <li>当浏览器再次发送请求的时候，会将这个<code>Session ID</code>带上，服务器接受到请求之后就会依据Session ID找到相应的Session。</li> <li>找到Session后，就可以在Session中获取或者添加内容了。</li></ol></blockquote> <p>而这些内容只会保存在服务器中，发到客户端的只有Session ID，这样相对安全，也节省了网络流量，因为不需要在Cookie中存储大量用户信息。</p> <p><strong>3. Session创建与存储</strong></p> <p>那么Session在何时何地创建呢？当然还是在服务器端程序运行的过程中创建的，不同语言实现的应用程序有不同的创建Session的方法。在Java中，是Web应用程序在调用<code>HttpServletRequest的getSession()</code>时，由Web容器（比如Tomcat）创建的。那<code>HttpServletRequest</code>又是什么呢？别着急，我后面再聊。</p> <p>Tomcat的Session管理器提供了多种持久化方案来存储Session，通常会采用高性能的存储方式，比如<code>Redis</code>，并且通过集群部署的方式，防止单点故障，从而提升高可用。同时，Session有过期时间，因此Tomcat会开启后台线程定期的轮询，如果Session过期了就将Session失效。</p> <p><strong>多说一下：现在的web容器都支持将session存储在第三方中间件（如<code>redis</code>）中</strong>，这是为什么？</p> <blockquote><p>用Web容器的Session方案需要侵入特定的Web容器，用Spring Session可能比较简单，不需要跟特定的Servlet容器打交道。</p> <p>这正是Spring喜欢做的事情，它使得程序员甚至感觉不到Servlet容器的存在，可以专心开发Web应用。但是Spring到底做了什么，Spring Session是如何实现的，我们还是有必要了解了解~</p> <p>其实它是通过Servlet规范中的Filter机制拦截了所有Servlet请求，偷梁换柱，将标准的Servlet请求对象包装了一下，换成它自己的Request包装类对象，这样当程序员通过包装后的<code>Request对象的getSession()</code> 拿Session时，是通过Spring拿Session，没Web容器什么事了。</p></blockquote> <h2 id="关于无状态"><a href="#关于无状态" aria-hidden="true" class="header-anchor">#</a> 关于无状态</h2> <p>在HTTP/1.0时期，每次HTTP请求都会创建一个新的TCP连接，请求完成后之后这个TCP连接就会被关闭。这种通信模式的效率不高，所以在HTTP/1.1中，引入了HTTP长连接的概念，使用长连接的HTTP协议，会在响应头加入<code>Connection:keep-alive</code>。这样当浏览器完成一次请求后，浏览器和服务器之间的TCP连接不会关闭，再次访问这个服务器上的网页时，浏览器会继续使用这一条已经建立的连接，也就是说两个请求可能共用一个TCP连接。</p> <p>但是上面提到HTTP的特点是无状态的，多个请求之间是没有关系的，这是不是矛盾了？</p> <p><strong>解释：</strong></p> <ol><li>Http的无状态理解是指不同请求间协议内容无相关性，即本次请求与上次请求没有内容的依赖关系，本次响应也只针对本次请求的数据，至于服务器应用程序为用户保存的状态是属于应用层，与协议是无关的。</li> <li><code>keep-alive</code>表示TCP的连接可以复用，指的是利用已有的传输通道进行http协议内容的传输，省去创建/关闭连接的开销达到提升性能的效果。应用程序其实一般不关心这次Http请求的TCP传输细节，只关心Http协议的内容，因此只要复用TCP连接时做好必要的数据重置，是不算有状态的。</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2019-5-26 22:56:45</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/CCSprouT/blog/tomcat/" class="prev router-link-active">
          Tomcat 容器
        </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/CCSprouT/assets/js/app.3bfe9cae.js" defer></script><script src="/CCSprouT/assets/js/2.354977f3.js" defer></script><script src="/CCSprouT/assets/js/16.6a35fdc0.js" defer></script>
  </body>
</html>
