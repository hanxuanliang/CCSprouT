<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>单表查询 | Coding Core Sprout</title>
    <meta name="description" content="Coding Core Sprout：处于萌芽阶段的 Code 核心知识库">
    
    
    <link rel="preload" href="/CCSprouT/assets/css/0.styles.b6092737.css" as="style"><link rel="preload" href="/CCSprouT/assets/js/app.0b13b99c.js" as="script"><link rel="preload" href="/CCSprouT/assets/js/2.354977f3.js" as="script"><link rel="preload" href="/CCSprouT/assets/js/7.ef897246.js" as="script"><link rel="prefetch" href="/CCSprouT/assets/js/10.e75a9570.js"><link rel="prefetch" href="/CCSprouT/assets/js/11.31aaf61d.js"><link rel="prefetch" href="/CCSprouT/assets/js/12.ac7e2971.js"><link rel="prefetch" href="/CCSprouT/assets/js/13.c22bbab2.js"><link rel="prefetch" href="/CCSprouT/assets/js/14.c458a828.js"><link rel="prefetch" href="/CCSprouT/assets/js/15.b9789fb3.js"><link rel="prefetch" href="/CCSprouT/assets/js/16.1fd3cc1d.js"><link rel="prefetch" href="/CCSprouT/assets/js/17.eee39a58.js"><link rel="prefetch" href="/CCSprouT/assets/js/18.7a9725ca.js"><link rel="prefetch" href="/CCSprouT/assets/js/19.841aab36.js"><link rel="prefetch" href="/CCSprouT/assets/js/20.1184d504.js"><link rel="prefetch" href="/CCSprouT/assets/js/21.7fd335b8.js"><link rel="prefetch" href="/CCSprouT/assets/js/22.f4350d9b.js"><link rel="prefetch" href="/CCSprouT/assets/js/23.6ccf6c92.js"><link rel="prefetch" href="/CCSprouT/assets/js/24.461b0a59.js"><link rel="prefetch" href="/CCSprouT/assets/js/25.1fcfa802.js"><link rel="prefetch" href="/CCSprouT/assets/js/26.7f097f75.js"><link rel="prefetch" href="/CCSprouT/assets/js/27.f0e625b6.js"><link rel="prefetch" href="/CCSprouT/assets/js/28.d0913d20.js"><link rel="prefetch" href="/CCSprouT/assets/js/29.43aec35e.js"><link rel="prefetch" href="/CCSprouT/assets/js/3.e19b12c7.js"><link rel="prefetch" href="/CCSprouT/assets/js/30.42967d39.js"><link rel="prefetch" href="/CCSprouT/assets/js/31.836b7182.js"><link rel="prefetch" href="/CCSprouT/assets/js/32.7fd5be3a.js"><link rel="prefetch" href="/CCSprouT/assets/js/33.d7dbe301.js"><link rel="prefetch" href="/CCSprouT/assets/js/34.2f93b963.js"><link rel="prefetch" href="/CCSprouT/assets/js/4.02903aa1.js"><link rel="prefetch" href="/CCSprouT/assets/js/5.da61bbd8.js"><link rel="prefetch" href="/CCSprouT/assets/js/6.35769643.js"><link rel="prefetch" href="/CCSprouT/assets/js/8.bffda061.js"><link rel="prefetch" href="/CCSprouT/assets/js/9.423e1d8b.js">
    <link rel="stylesheet" href="/CCSprouT/assets/css/0.styles.b6092737.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/CCSprouT/" class="home-link router-link-active"><!----> <span class="site-name">Coding Core Sprout</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/CCSprouT/welcome/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">My-Blog</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/mysql/" class="nav-link router-link-active">Mysql</a></li><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/network/" class="nav-link">Network</a></li></ul></div></div><div class="nav-item"><a href="/CCSprouT/ts-axios/" class="nav-link">TS-axios 重构文档</a></div><div class="nav-item"><a href="https://github.com/hanxuanliang/CCSprouT" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/CCSprouT/welcome/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">My-Blog</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/mysql/" class="nav-link router-link-active">Mysql</a></li><li class="dropdown-item"><!----> <a href="/CCSprouT/blog/network/" class="nav-link">Network</a></li></ul></div></div><div class="nav-item"><a href="/CCSprouT/ts-axios/" class="nav-link">TS-axios 重构文档</a></div><div class="nav-item"><a href="https://github.com/hanxuanliang/CCSprouT" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Mysql</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CCSprouT/blog/mysql/" class="sidebar-link">Introduction</a></li><li><a href="/CCSprouT/blog/mysql/single-table-Query.html" class="active sidebar-link">单表查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/CCSprouT/blog/mysql/single-table-Query.html#access-method" class="sidebar-link">access method</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="content default"><h1 id="单表查询"><a href="#单表查询" aria-hidden="true" class="header-anchor">#</a> 单表查询</h1> <p>对于大多数<code>Mysql</code>使用者而言，<code>Mysql</code>其实就是一个软件，平时最多使用的的功能就是 <code>查询</code> 。当然这是对我们这些开发者而言，<code>DBA</code> 这些专业的数据库职业人而言，可能还涉及到性能优化（但是我这篇文章是针对开发者的）。是时候展示真正的技术了。</p> <p>我们先来看看 <code>Mysql</code> 是怎么执行单表查询的 。</p> <p>所以我们先开一个表：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> single_table <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    key1 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key2 <span class="token keyword">INT</span><span class="token punctuation">,</span>
    key3 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key_part1 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key_part2 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key_part3 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    common_field <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">KEY</span> idx_key1 <span class="token punctuation">(</span>key1<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> idx_key2 <span class="token punctuation">(</span>key2<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">KEY</span> idx_key3 <span class="token punctuation">(</span>key3<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">KEY</span> idx_key_part<span class="token punctuation">(</span>key_part1<span class="token punctuation">,</span> key_part2<span class="token punctuation">,</span> key_part3<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">Engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre></div><p>然后我们来看看表的具体情况（<code>在Mysql里面</code>）：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql root<span class="token variable">@localhost</span>:study_mysql_test<span class="token operator">&gt;</span> <span class="token keyword">show</span>  <span class="token keyword">columns</span> <span class="token keyword">from</span> single_table<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------+--------------+------+-----+---------+----------------+</span>
<span class="token operator">|</span> Field        <span class="token operator">|</span> <span class="token keyword">Type</span>         <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> <span class="token keyword">Key</span> <span class="token operator">|</span> <span class="token keyword">Default</span> <span class="token operator">|</span> Extra          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+--------------+------+-----+---------+----------------+</span>
<span class="token operator">|</span> id           <span class="token operator">|</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>      <span class="token operator">|</span> <span class="token keyword">NO</span>   <span class="token operator">|</span> PRI <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">&gt;</span>  <span class="token operator">|</span> <span class="token keyword">auto_increment</span> <span class="token operator">|</span>
<span class="token operator">|</span> key1         <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span> MUL <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">&gt;</span>  <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> key2         <span class="token operator">|</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>      <span class="token operator">|</span> YES  <span class="token operator">|</span> UNI <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">&gt;</span>  <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> key3         <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span> MUL <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">&gt;</span>  <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> key_part1    <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span> MUL <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">&gt;</span>  <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> key_part2    <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">&gt;</span>  <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> key_part3    <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">&gt;</span>  <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">|</span> common_field <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">&gt;</span>  <span class="token operator">|</span>                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------+--------------+------+-----+---------+----------------+</span>
<span class="token number">8</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span>
<span class="token keyword">Time</span>: <span class="token number">0.024</span>s                                                            
</code></pre></div><p>然后我们再来看看其他一些字段是什么：</p> <ul><li>为<code>id</code>列建立的聚簇索引。</li> <li>为<code>key1</code>列建立的<code>idx_key1</code>二级索引。</li> <li>为<code>key2</code>列建立的<code>idx_key2</code>二级索引，而且该索引是唯一二级索引。</li> <li>为<code>key3</code>列建立的<code>idx_key3</code>二级索引。</li> <li>为<code>key_part1</code>、<code>key_part2</code>、<code>key_part3</code>列建立的<code>idx_key_part</code>二级索引，这也是一个联合索引。</li></ul> <h2 id="access-method"><a href="#access-method" aria-hidden="true" class="header-anchor">#</a> access method</h2> <p><code>Mysql</code>的设计者把<code>MySQL</code>执行查询语句的方式称之为<code>访问方法</code>或者<code>访问类型</code>。同一个查询语句可能可以使用多种不同的访问方法来执行，虽然最后的查询结果都是一样的，但是执行的时间可能相差甚远。而设计者把查询的执行方式大致分为两种：</p> <ul><li><p><strong>全表扫描查询</strong></p> <p>这种执行方式好理解，就是把表的每一行记录都扫一遍，然后把符合条件的记录加入结果集里面。而且不管是扫描查询都可以使用这种方式。当然，这也是最笨的方式。</p></li> <li><p><strong>索引查询</strong></p> <p>直接使用索引来执行查询相比于全表查询可能会加快查询执行的时间。当然这个也可以再细分：</p> <ul><li>主键或唯一二级索引的等值查询</li> <li>普通二级索引的等值查询</li> <li>索引列的范围查询</li> <li>直接扫描整个索引</li></ul></li></ul> <p>下面我们就来试试 <code>访问方法</code> 的具体内容吧！</p> <h3 id="主键"><a href="#主键" aria-hidden="true" class="header-anchor">#</a> 主键</h3> <p>这个是我们常见的手法，通过主键 <code>id</code> 来定位一条记录，例如：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> single_table <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1438</span><span class="token punctuation">;</span>
</code></pre></div><p><code>MySQL</code>会直接利用主键值在聚簇索引中定位对应的用户记录，就像这样：</p> <p><img src="/%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95%E7%A4%BA%E4%BE%8B%E5%9B%BE.jpg" alt="聚簇索引示例图"></p> <p>记录中只展示我们关心的索引列，对于<code>single_table</code>表的聚簇索引来说，展示的就是<code>id</code>列。我想突出的重点就是：<strong><code>B+</code>树叶子节点中的记录是按照索引列排序的</strong>，对于的聚簇索引来说，<strong>它对应的<code>B+</code>树叶子节点中的记录就是按照<code>id</code>列排序的</strong>。<code>B+</code>树本来就是一个矮矮的大胖子，所以这样根据主键值定位一条记录的速度超快，类似的，我们根据唯一二级索引列来定位一条记录的速度也是很快的。例如：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> single_table <span class="token keyword">WHERE</span> key2 <span class="token operator">=</span> <span class="token number">3841</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="/%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95%E7%A4%BA%E6%84%8F%E5%9B%BE.jpg" alt="二级索引示意图"></p> <p>可以看到这个查询的执行分两步，</p> <ul><li>第一步先从<code>idx_key2</code>对应的<code>B+</code>树索引中根据<code>key2</code>列比较条件定位到一条二级索引记录</li> <li>然后再根据该记录的<code>id</code>值到聚簇索引中获取到完整的用户记录。</li></ul> <p>而我们注意到上述的查询都是等值查询，<code>Mysql</code> 设计者把这种通过主键或者唯一二级索引列来定位一条记录的访问方法定义为：<code>const</code>， 大概的意思是常数时间内可以查询出来。而刚刚我也说了，这种<code>const</code>访问方法只能在主键列或者唯一二级索引列和一个常数进行<strong>等值比较</strong>时才有效。</p> <h3 id="普通的二级索引"><a href="#普通的二级索引" aria-hidden="true" class="header-anchor">#</a> 普通的二级索引</h3> <p>我们对某个普通的二级索引列与常数进行等值比较，比如这样：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> single_table <span class="token keyword">WHERE</span> key1 <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token punctuation">;</span>
</code></pre></div><p>我们一般先使用二级索引找到对应记录的<code>id</code>值，然后再回表到聚簇索引中查找完整的用户记录。由于普通二级索引并不限制索引列值的唯一性，所以可能找到多条对应的记录，所以说使用二级索引来执行查询的代价取决于等值匹配到的二级索引记录条数。</p> <p>而在回表这个操作，<code>Mysql</code> 设计者把这种搜索条件为二级索引列与常数等值比较，采用二级索引来执行查询的访问方法称为：<code>ref</code></p> <p><img src="/%E6%99%AE%E9%80%9A%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95.jpg" alt="普通二级索引"></p> <p>在图中我们看见，对于普通的二级索引来说，通过索引列进行等值比较后可能匹配到多条连续的记录，而不是像主键或者唯一二级索引那样最多只能匹配1条记录。所以这种<code>ref</code>访问方法比<code>const</code>差了那么一点点。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">5/9/2019, 3:42:06 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/CCSprouT/blog/mysql/" class="prev router-link-active">
          Introduction
        </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/CCSprouT/assets/js/app.0b13b99c.js" defer></script><script src="/CCSprouT/assets/js/2.354977f3.js" defer></script><script src="/CCSprouT/assets/js/7.ef897246.js" defer></script>
  </body>
</html>
