# IP是怎么来的，又是怎么没的？

在网络世界里面，如果需要和其他机器通讯，我们一个通讯地址，所以我们需要给网卡配置这么一个地址。

## 如何配置IP地址？

使用命令行自己配置即可。设置好了，用这两个命令，将网卡up一下，就可以开始工作。

```
sudo ifconfig eth1 10.0.0.1/24
sudo ifconfig eth1 up
```

你可能会问，这也太自由了，那我是不是配置什么都可以？如果配置一个和谁都不搭边的地址呢？例如，机房旁边的机器都是192.168.1.x，我非要配置一个16.158.23.6，会出现什么现象？

哈哈哈！不会出现任何现象，**就是包发不出去**。为什么呢？我来举例说明一下。

### 解释

192.168.1.6 就在你这台机器的旁边，甚至是在同一个交换机上，而你把机器的地址设为了 16.158.23.6。在这台机器上，你企图去 ping192.168.1.6，你觉得只要将包发出去，同一个交换机的另一台机器马上就能收到，对不对？

可是它没你想得那么智能。你用肉眼看到那台机器就在旁边，它则需要根据自己的逻辑进行处理。

> 网络交换资源的原则：**只要是在网络上跑的包，都是完整的，可以有下层没上层，绝对不可能有上层没下层。**

所以，你看着它有自己的源 IP 地址 16.158.23.6，也有目标 IP 地址 192.168.1.6，但是包发不出去，这是因为 MAC 层还没填。

自己的 MAC 地址自己知道，这个容易。但是目标 MAC 填什么呢？是不是填 192.168.1.6 这台机器的 MAC 地址呢？

当然不是。机器首先会判断，要去的这个地址和我是一个网段的吗，或者和我的一个网卡是同一网段的吗？只有是一个网段的，它才会发送 ARP 请求，获取 MAC 地址。如果发现不是呢？

> **Linux 默认的逻辑是，如果这是一个跨网段的调用，它便不会直接将包发送到网络上，而是企图将包发送到网关。**

如果你配置了网关的话，Linux 会获取网关的 MAC 地址，然后将包发出去。对于 192.168.1.6 这台机器来讲，虽然路过它家门的这个包，目标 IP 是它，但是无奈 MAC 地址不是它的，所以它的网卡是不会把包收进去的。

如果没有配置网关呢？那包压根就发不出去。

如果将网关配置为 192.168.1.6 呢？不可能，Linux 不会让你配置成功的，因为网关要和当前的网络至少一个网卡是同一个网段的，怎么可能 16.158.23.6 的网关是 192.168.1.6 呢？

所以，当你需要手动配置一台机器的网络 IP 时，一定要好好问问你的网络管理员。如果在机房里面，要去网络管理员那里申请，让他给你分配一段正确的 IP 地址。当然，真正配置的时候，一定不是直接用命令配置的，而是放在一个配置文件里面。**不同系统的配置文件格式不同，但是无非就是 CIDR、子网掩码、广播地址和网关地址**。

### 总结

- 知道互相的IP地址，MAC地址也得知道（上层协议需要下层协议的支持）

- 如果是一个网段，它会发送 ARP 请求，获取 MAC 地址。

- 如果这是一个跨网段的调用，它便不会直接将包发送到网络上，而是企图将包发送到网关。

## 动态主机配置协议（DHCP）

你可能会问了，配置了 IP 之后一般不能变的，配置一个服务端的机器还可以，但是如果是客户端的机器呢？我抱着一台笔记本电脑到处走，或者白天来晚上走，每次使用都要配置 IP 地址，那可怎么办？如果公司所有的电脑都需要 IT 人员配置，肯定忙不过来啊。

因此，我们需要有一个自动配置的协议，也就是称**动态主机配置协议（Dynamic Host Configuration Protocol）**，简称**DHCP**。

有了这个协议，网络管理员就轻松多了。**他只需要配置一段共享的 IP 地址**。每一台新接入的机器都通过 DHCP 协议，来这个共享的 IP 地址里申请，然后自动配置好就可以了。**等人走了，或者用完了，还回去，这样其他的机器也能用。**

### 解析DHCP的工作方式

当一台机器新加入一个网络的时候，肯定一脸懵逼，啥情况都不知道，只知道自己的 MAC 地址。这一步，我们称为**DHCP Discover。**

新来的机器使用 **IP 地址 0.0.0.0** 发送了一个**广播包**，**目的 IP 地址为 255.255.255.255**。广播包封装了 UDP，UDP 封装了 BOOTP。其实 DHCP 是 BOOTP 的增强版，但是如果你去抓包的话，很可能看到的名称还是 BOOTP 协议。

![](https://github.com/hanxuanliang/CCSprouT/blob/gh-pages/DHCP-Discover.jpg)

如果一个网络管理员在网络里面配置了**DHCP Server**的话，他就相当于这些 IP 的管理员。他立刻能知道来了一个“新人”。这个时候，我们可以体会 MAC 地址唯一的重要性了。当一台机器带着自己的 MAC 地址加入一个网络的时候，MAC 是它唯一的身份，如果连这个都重复了，就没办法配置了。

只有 MAC 唯一，IP 管理员才能知道这是一个新人，需要租给它一个 IP 地址，这个过程我们称为**DHCP Offer**。同时，DHCP Server 为此客户保留为它提供的 IP 地址，从而不会为其他 DHCP 客户分配此 IP 地址。

DHCP Offer 的格式就像这样，里面有给新人分配的地址。

![](https://github.com/hanxuanliang/CCSprouT/blob/gh-pages/DHCP-Offer.jpg)

DHCP Server 仍然使用**广播地址作为目的地址**，因为，此时请求分配 IP 的新人还没有自己的 IP。DHCP Server 回复说，我分配了一个可用的 IP 给你，你看如何？除此之外，服务器还发送了子网掩码、网关和 IP 地址租用期等信息。

如果有多个 DHCP Server，它会选择其中一个 DHCP Offer，一般是最先到达的那个，并且会向网络发送一个 **DHCP Request 广播数据包**，包中包含**客户端的 MAC 地址、接受的租约中的 IP 地址、提供此租约的 DHCP 服务器地址**等，并告诉所有 DHCP Server 它将接受哪一台服务器提供的 IP 地址，告诉其他 DHCP 服务器，谢谢你们的接纳，并请求撤销它们提供的 IP 地址，以便提供给下一个 IP 租用请求者。

![](https://github.com/hanxuanliang/CCSprouT/blob/gh-pages/DHCP-Request广播数据包.jpg)

此时，由于还没有得到 DHCP Server 的最后确认，客户端仍然使用 0.0.0.0 为源 IP 地址、255.255.255.255 为目标地址进行广播。在 BOOTP 里面，接受某个 DHCP Server 的分配的 IP。

当 DHCP Server 接收到客户机的 DHCP request 之后，会广播返回给客户机一个 DHCP ACK 消息包，表明已经接受客户机的选择，并将这一 IP 地址的合法租用信息和其他的配置信息都放入该广播包，发给客户机，欢迎它加入网络大家庭。

> 有点像3次握手，但是网络世界的东西不就是异曲同工之妙吗

![](https://github.com/hanxuanliang/CCSprouT/blob/gh-pages/DHCP-Server确定.jpg)

### IP是怎么收回的

如果不用的话，自然就会收回了。而如果还要继续续期的话，不能到了时间再续期，而是提前一段时间和DHCP服务端说。

> 客户机会在租期过去 50% 的时候，直接向为其提供 IP 地址的 DHCP Server 发送 DHCP request 消息包。客户机接收到该服务器回应的 DHCP ACK 消息包，会根据包中所提供的新的租期以及其他已经更新的 TCP/IP 参数，更新自己的配置。这样，IP 租用更新就完成了。

## 总结

- DHCP 协议主要是用来给客户租用 IP 地址，和房产中介很像，要商谈、签约、续租，广播还不能“抢单”（先来先得，迟到了就下一次吧）
